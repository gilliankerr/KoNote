{% load i18n %}
{% load permissions_tags %}
<!-- Partial: Info tab content -->

{# Anonymised record banner #}
{% if client.is_anonymised %}
<article aria-label="notice" style="border-left: 4px solid var(--pico-muted-border-color); background: var(--pico-card-background-color);">
    <strong>{% trans "This record has been anonymised." %}</strong>
    {% trans "Identifying information has been removed. Service records are retained for statistical and compliance purposes." %}
</article>
{% endif %}

{# Consent warning - only shown when missing #}
{% if not client.consent_given_at %}
<section id="consent-section" aria-labelledby="consent-heading">
    {% include "clients/_consent_display.html" %}
</section>
{% endif %}

{# Quick info row - high-frequency data for front desk #}
<section class="quick-info-section">
    <dl class="quick-info">
        {% if visible_fields.birth_date and client.birth_date %}
        <div class="quick-info-item">
            <dt>{% trans "DOB" %}</dt>
            <dd>{{ client.birth_date }}</dd>
        </div>
        {% endif %}
        {% if enrolments %}
        <div class="quick-info-item">
            <dt>{{ term.program_plural|default:"Programs" }}</dt>
            <dd>
                {% for e in enrolments %}
                <span class="program-indicator"><span class="program-dot" style="background-color: {{ e.program.colour_hex }}" aria-hidden="true"></span>{{ e.program.translated_name }}</span>{% if not forloop.last %} · {% endif %}
                {% endfor %}
            </dd>
        </div>
        {% endif %}
    </dl>
</section>

{# Staff message actions — leave or view messages #}
{% if not client.is_anonymised %}
{% has_permission "message.leave" as can_leave_message %}
{% has_permission "message.view" as can_view_messages %}
{% if can_leave_message or can_view_messages %}
<section class="quick-info-section">
    {% if can_leave_message %}
    <a href="{% url 'communications:leave_message' client.pk %}" role="button" class="outline">{% trans "Leave Message" %}</a>
    {% endif %}
    {% if can_view_messages %}
    <a href="{% url 'communications:client_messages' client.pk %}" role="button" class="secondary outline">{% trans "View Messages" %}</a>
    {% endif %}
</section>
{% endif %}
{% endif %}

{# Contact & Messaging Consent — staff and above #}
{% if not is_receptionist and not client.is_anonymised %}
<section>
    <details open>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Contact & Reminders" %}</h2></summary>
        <div style="margin-top: var(--kn-space-base);">
            <dl class="info-grid-compact">
                {% if client.phone %}
                <div class="info-field">
                    <dt>{% trans "Phone" %}</dt>
                    <dd>
                        {{ client.phone }}
                        {% if client.phone_last_confirmed %}
                            {% now "Y-m-d" as today %}
                            {# Phone staleness indicator #}
                            <small class="secondary">({% trans "confirmed" %} {{ client.phone_last_confirmed|date:"M d, Y" }})</small>
                        {% endif %}
                    </dd>
                </div>
                {% endif %}
                {% if client.email %}
                <div class="info-field">
                    <dt>{% trans "Email" %}</dt>
                    <dd>{{ client.email }}</dd>
                </div>
                {% endif %}
                <div class="info-field">
                    <dt>{% trans "Preferred Language" %}</dt>
                    <dd>{{ client.get_preferred_language_display|default:"English" }}</dd>
                </div>
            </dl>

            {# Consent status — simple display #}
            <div style="margin-top: var(--kn-space-sm);">
                {% if client.sms_consent %}
                <span class="badge badge-success">{% trans "Text reminders: Yes" %}</span>
                {% else %}
                <span class="badge badge-neutral">{% trans "Text reminders: No" %}</span>
                {% endif %}
                {% if client.email_consent %}
                <span class="badge badge-success">{% trans "Email reminders: Yes" %}</span>
                {% else %}
                <span class="badge badge-neutral">{% trans "Email reminders: No" %}</span>
                {% endif %}
            </div>

            {# Phone verified button #}
            {% if client.phone %}
            <form method="post" action="{% url 'clients:client_confirm_phone' client_id=client.pk %}" style="margin-top: var(--kn-space-sm);">
                {% csrf_token %}
                <button type="submit" class="outline secondary" style="padding: var(--kn-space-xs) var(--kn-space-sm); font-size: 0.75rem;">
                    {% trans "Mark Phone as Verified" %}
                </button>
            </form>
            {% endif %}
        </div>
    </details>
</section>
{% endif %}

{# Additional details - only if client has middle name or custom data #}
{% if client.middle_name or custom_data %}
<section>
    <details open>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Details" %}</h2></summary>

        {% if client.middle_name %}
        <dl class="info-grid-compact" style="margin-top: var(--kn-space-base);">
            <div class="info-field">
                <dt>{% trans "Middle Name" %}</dt>
                <dd>{{ client.middle_name }}</dd>
            </div>
        </dl>
        {% endif %}

        {% if custom_data %}
        <div id="custom-fields-section">
            {% include "clients/_custom_fields_display.html" %}
        </div>
        {% endif %}
    </details>
</section>
{% endif %}

{# Consent details (when recorded) - collapsed by default #}
{% if client.consent_given_at %}
<section id="consent-section">
    <details>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Privacy Consent" %}</h2></summary>
        <div style="margin-top: var(--kn-space-base);">
            {% include "clients/_consent_display.html" %}
        </div>
    </details>
</section>
{% endif %}

{# Cross-program sharing consent — visible to staff and above #}
{% if not is_receptionist and not client.is_anonymised %}
<section>
    <details>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Cross-Program Sharing" %}</h2></summary>
        <div style="margin-top: var(--kn-space-base);">
            {% if client.cross_program_sharing_consent %}
            <p><span class="badge badge-success">{% trans "Consent given" %}</span></p>
            <p class="secondary">{% trans "This participant has consented to sharing clinical information across programs." %}</p>
            {% else %}
            <p><span class="badge badge-neutral">{% trans "No consent" %}</span></p>
            <p class="secondary">{% trans "Clinical notes are only visible within the program where they were recorded. Under Ontario privacy law (PHIPA), express consent is required before clinical information can be shared across programs." %}</p>
            {% endif %}
            <small class="secondary"><em>{% trans "Note: Cross-program note filtering will be enforced in a future update. This setting is being recorded now for when enforcement is enabled." %}</em></small>
        </div>
    </details>
</section>
{% endif %}

{# Participant Portal — staff + PM, gated on feature toggle #}
{% if features.participant_portal and not is_receptionist and not client.is_anonymised %}
<section>
    <details>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Participant Portal" %}</h2></summary>
        <div style="margin-top: var(--kn-space-base);">
            {% if client.portal_account.is_active %}
            <p><span class="badge badge-success">{% trans "Portal access: Active" %}</span></p>
            <a href="{% url 'clients:portal_manage' client_id=client.pk %}" class="secondary" style="font-size: 0.875rem;">{% trans "Manage portal access" %}</a>
            {% elif client.portal_account.pk %}
            <p><span class="badge badge-neutral">{% trans "Portal access: Deactivated" %}</span></p>
            <a href="{% url 'clients:portal_manage' client_id=client.pk %}" class="secondary" style="font-size: 0.875rem;">{% trans "Manage portal access" %}</a>
            {% else %}
            <p class="secondary">{% trans "No portal account." %}</p>
            <a href="{% url 'clients:create_portal_invite' client_id=client.pk %}" role="button" class="outline" style="font-size: 0.875rem;">{% trans "Invite to Portal" %}</a>
            {% endif %}
        </div>
    </details>
</section>
{% endif %}

{# Privacy & Data Management — collapsed, PM+ only, not shown for anonymised clients #}
{% if is_pm_or_admin and not client.is_anonymised %}
<section>
    <details>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Privacy & Data Management" %}</h2></summary>
        <div style="margin-top: var(--kn-space-base);">
            <p class="secondary">{% trans "These actions are for privacy compliance and data governance. Data erasure is permanent and irreversible." %}</p>
            {% if pending_erasure %}
            <span class="badge badge-warning">{% trans "Erasure Pending" %}</span>
            {% else %}
            <a href="{% url 'clients:client_erasure_request' client_id=client.pk %}" class="secondary" style="font-size: 0.875rem;">{% trans "Request Irreversible Data Erasure" %}</a>
            {% endif %}
        </div>
    </details>
</section>
{% endif %}
