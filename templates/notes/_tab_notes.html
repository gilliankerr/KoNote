{% load i18n %}
<!-- Partial: Notes tab content -->
<div class="action-bar">
    <a href="{% url 'notes:quick_note_create' client_id=client.pk %}" role="button">{{ term.quick_note|default:"Quick Note" }}</a>
    <a href="{% url 'notes:note_create' client_id=client.pk %}" role="button" class="outline">{% blocktrans with note=term.progress_note|default:"Note" %}Full {{ note }}{% endblocktrans %}</a>
</div>

<!-- Filters (collapsed by default, expand to refine) -->
<details class="filter-bar"{% if active_filter_count %} open{% endif %}>
    <summary>
        {% trans "Filter notes" %}{% if active_filter_count %}
            <span class="badge badge-info">{{ active_filter_count }}</span>
        {% endif %}
    </summary>
    <form method="get" action="{% url 'notes:note_list' client_id=client.pk %}">
        <div class="grid">
            <label>
                {% trans "Type" %}
                <select name="type">
                    <option value="">{% trans "All types" %}</option>
                    <option value="quick" {% if filter_type == "quick" %}selected{% endif %}>{% trans "Quick notes" %}</option>
                    <option value="full" {% if filter_type == "full" %}selected{% endif %}>{% trans "Full notes" %}</option>
                </select>
            </label>
            <label>
                {% trans "Author" %}
                <select name="author">
                    <option value="">{% trans "All staff" %}</option>
                    <option value="mine" {% if filter_author == "mine" %}selected{% endif %}>{% trans "My notes only" %}</option>
                </select>
            </label>
            <label>
                {% trans "From date" %}
                <input type="date" name="date_from" value="{{ filter_date_from }}">
            </label>
            <label>
                {% trans "To date" %}
                <input type="date" name="date_to" value="{{ filter_date_to }}">
            </label>
        </div>
        <div role="group">
            <button type="submit" class="outline">{% trans "Apply filters" %}</button>
            <a href="{% url 'notes:note_list' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Clear" %}</a>
        </div>
    </form>
</details>

{% if page %}
<div id="notes-timeline">
    {% for note in page %}
    <div class="note-card{% if note.status == 'cancelled' %} note-card--cancelled{% endif %}"
         id="note-{{ note.pk }}"
         hx-get="{% url 'notes:note_detail' note_id=note.pk %}"
         hx-target="#note-{{ note.pk }}"
         hx-swap="innerHTML"
         hx-indicator="#loading-bar"
         role="button"
         tabindex="0"
         aria-label="{% if note.note_type == 'quick' %}{{ term.quick_note|default:'Quick note' }}{% else %}{% trans 'Full note' %}{% endif %} â€” {{ note.effective_date|date:'M d, Y' }}">
        <div class="note-card-header">
            {% if note.note_type == "quick" %}
                <span class="badge badge-info">{{ term.quick_note|default:"Quick" }}</span>
            {% else %}
                <span class="badge badge-success">{% trans "Full" %}</span>
            {% endif %}
            {% if note.status == "cancelled" %}
                <span class="badge badge-danger">{% trans "Cancelled" %}</span>
            {% endif %}
            <span class="note-card-date">{{ note.effective_date|date:"M d, Y" }}</span>
            <span class="note-card-ago">{{ note.effective_date|timesince }} {% trans "ago" %}</span>
        </div>
        <div class="note-card-author">
            {% if note.author %}{{ note.author.display_name|default:note.author }}{% else %}{% trans "(unknown)" %}{% endif %}{% if note.author_program %} &middot; {{ note.author_program.name }}{% endif %}
        </div>
        {% if note.status == "cancelled" %}
            <p class="note-card-preview"><del>{{ note.notes_text|truncatechars:200 }}</del></p>
            {% if note.status_reason %}<p class="note-card-reason">{% trans "Reason:" %} {{ note.status_reason }}</p>{% endif %}
        {% else %}
            {% if note.notes_text %}
                <p class="note-card-preview">{{ note.notes_text|truncatechars:200 }}</p>
            {% endif %}
        {% endif %}
        <div class="note-card-meta">
            {% if note.target_count %}
                <span class="note-chip">{% blocktrans count target_count=note.target_count %}{{ target_count }} target{% plural %}{{ target_count }} targets{% endblocktrans %}</span>
            {% endif %}
            {% if note.template %}
                <span class="note-chip">{{ note.template.name }}</span>
            {% endif %}
            {% if note.follow_up_date %}
                <span class="note-chip note-chip--followup{% if note.follow_up_completed_at %} note-chip--done{% endif %}">
                    {% if note.follow_up_completed_at %}&#10003; {% endif %}{% trans "Follow-up" %} {{ note.follow_up_date|date:"M d" }}
                </span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% if page.has_other_pages %}
<nav class="pagination" aria-label="{% trans 'Notes pagination' %}">
    {% if page.has_previous %}
    <a href="?page={{ page.previous_page_number }}&type={{ filter_type }}&author={{ filter_author }}&date_from={{ filter_date_from }}&date_to={{ filter_date_to }}">{% trans "Previous" %}</a>
    {% else %}
    <span class="secondary">{% trans "Previous" %}</span>
    {% endif %}
    {% blocktrans with current=page.number total=page.paginator.num_pages %}Page {{ current }} of {{ total }}{% endblocktrans %}
    {% if page.has_next %}
    <a href="?page={{ page.next_page_number }}&type={{ filter_type }}&author={{ filter_author }}&date_from={{ filter_date_from }}&date_to={{ filter_date_to }}">{% trans "Next" %}</a>
    {% else %}
    <span class="secondary">{% trans "Next" %}</span>
    {% endif %}
</nav>
{% endif %}

{% else %}
<div class="empty-state">
    <p>{% blocktrans with notes=term.progress_note|default:"notes" %}No {{ notes }} recorded yet.{% endblocktrans %}</p>
    <a href="{% url 'notes:quick_note_create' client_id=client.pk %}" role="button">{% trans "Add the first note" %}</a>
</div>
{% endif %}
